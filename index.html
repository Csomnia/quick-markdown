<!DOCTYPE html>
<html lang="zh-​cmn-Hans">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Quick Markdown</title>
    <link rel="stylesheet" href="./statics/default.min.css">
    <link rel="stylesheet" href="./statics/md.style.default.css">
</head>
<body>
    <header id="header"></header>
    <article id="article">
    </article>
    <footer id="footer" style="display: none;">
        <a id="footer-link" class="footer-link" href="/">返回首页</a>
    </footer>
    <script src="./config.js"></script>
    <script>
        var $footerLink = document.getElementById('footer-link')
        $footerLink.href = window.location.pathname + '?' + Config.homepage
        document.title = Config.defaultTitle || 'Quick Markdown'
        var notFoundMessage = Config.notFoundText || '404 not found'

        var query = window.location.search.substring(1)
        if (query) {
            document.getElementById('footer').style.display = 'block'
        }

        function loadPage (mdRender, query, errfn) {
            loadFile(resolveQuery(query), function (data) {
                renderPage(data, mdRender)
            }, function () {
                loadFile(resolveQuery(query, true), function (data) {
                    renderPage(data, mdRender)
                }, function () {
                    typeof errfn === 'function' ? errfn() : ''
                })
            })
        }
        function load404 (mdRender) {
            document.title = '404'
            if (Config.notFoundPage) {
                loadPage(mdRender, Config.notFoundPage, function () {
                    document.getElementById('article').innerHTML = '<p style="text-align: center;">' + notFoundMessage + '</p>'
                })
            } else {
                document.getElementById('article').innerHTML = '<p style="text-align: center;">' + notFoundMessage + '</p>'
            }
        }
        function renderPage (data, mdRender) {
            document.getElementById('article').innerHTML = mdRender.render(data)
            try {
                document.title = document.getElementsByClassName('doc-title')[0].textContent
            } catch (_) {}
        }
        function resolveQuery (query, isFileName) {
            if (query.substring(query.length - 3) === '.md') {
                return Config.docRoot + query
            }
            return query
            ? decodeURIComponent(Config.docRoot + query + (isFileName ? '.md' : '/index.md'))
            : resolveQuery(Config.homepage || 'index.md')
        }

        function loadFile (path, fn, errfn) {
            const request = new XMLHttpRequest()
            request.open('get', path)
            request.send(null)
            request.onload = function () {
                if (request.readyState === 4) {
                    if (request.status === 200) {
                        fn(request.responseText)
                    } else {
                        console.warn('Load file ' + path + ' failed.')
                        typeof errfn === 'function' ? errfn() : ''
                    }
                }
            }
        }
    </script>
    <script src="./statics/markdown-it.js"></script>
    <script src="./statics/markdown-it-mark.js"></script>
    <script src="./statics/markdown-it-container.js"></script>
    <script>
        // IE
        var userAgent = window.navigator.userAgent.toLowerCase()
        if (userAgent.indexOf('trident') !== -1) {
            document.getElementById('header').innerHTML = '<p style="text-align: center; padding-top: 20px;">你的浏览器版本太老了！推荐你使用 <a href="https://www.google.cn/chrome/">Chrome 浏览器</a>'

            var md = markdownit({
                html: true,
            })
            md.use(markdownitMark)
            .use(markdownitContainer, 'tips')
            .use(markdownitContainer, 'warning')

            loadPage(md, query, function () {
                load404(md)
            })
            throw new Error('You are in IE.')
        }
        
    </script>
    <script src="./statics/markdown-it-anchor.js"></script>
    <script src="./statics/markdown-it-toc-done-right.js"></script>
    <script src="./statics/highlight.min.js"></script>
    <script>
        var md = markdownit({
            html: true,
            highlight: function (str, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    try {
                        return '<pre class="hljs"><code>' +
                         hljs.highlight(str, { language: lang }).value
                         + '</code></pre>'
                    } catch (_) {}
                }
                return '<pre class="hljs"><code>' +
                         md.utils.escapeHtml(str)
                         + '</code></pre>'
            }
        })
        md.use(markdownItAnchor, {
            level: 1,
            permalink: false,
        }).use(markdownItTocDoneRight)
        .use(markdownitMark)
        .use(markdownitContainer, 'green')
        .use(markdownitContainer, 'red')

        loadPage(md, query, function () {
            load404(md)
        })

    </script>
    <script src="./plugins/files-list/ui.js"></script>
</body>
</html>
